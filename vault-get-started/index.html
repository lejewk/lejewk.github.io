<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="cj3SRJgTsxv9bZn3usdMrLnB2zDldUTicKvaNmpcmHs">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"lejewk.github.io","root":"/","scheme":"Gemini","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="vault 란?토큰, 비밀번호, 인증서 ,암호화 키와 같은 비밀 정보나 민감한 데이터를UI, CLI, HTTP API 를 활용할때안전하게 저장하고 제어할수 있게 해주는 오픈 소스 입니다.https:&#x2F;&#x2F;www.vaultproject.io&#x2F; server 실행테스트를 위해 -dev 모드로 서버를 실행합니다. 123456789101112131415161718192">
<meta property="og:type" content="article">
<meta property="og:title" content="hashicorp Vault 시작 (tutorial)">
<meta property="og:url" content="https://lejewk.github.io/vault-get-started/index.html">
<meta property="og:site_name" content="개발자님 cs 드세요">
<meta property="og:description" content="vault 란?토큰, 비밀번호, 인증서 ,암호화 키와 같은 비밀 정보나 민감한 데이터를UI, CLI, HTTP API 를 활용할때안전하게 저장하고 제어할수 있게 해주는 오픈 소스 입니다.https:&#x2F;&#x2F;www.vaultproject.io&#x2F; server 실행테스트를 위해 -dev 모드로 서버를 실행합니다. 123456789101112131415161718192">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://user-images.githubusercontent.com/11376406/69770027-b66ec480-11ca-11ea-9cfa-7647707a0715.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/11376406/69770026-b66ec480-11ca-11ea-8579-15e5de885c12.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/11376406/69770332-f3878680-11cb-11ea-8c06-3d03c5299aa8.png">
<meta property="article:published_time" content="2019-11-28T00:48:33.000Z">
<meta property="article:modified_time" content="2020-03-06T07:24:14.580Z">
<meta property="article:author" content="이재욱이">
<meta property="article:tag" content="consul">
<meta property="article:tag" content="vault">
<meta property="article:tag" content="hashicorp">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/11376406/69770027-b66ec480-11ca-11ea-9cfa-7647707a0715.png">

<link rel="canonical" href="https://lejewk.github.io/vault-get-started/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true
  };
</script>

  <title>hashicorp Vault 시작 (tutorial) | 개발자님 cs 드세요</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-138075260-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-138075260-1');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

  <!-- google adsense start -->
<script data-ad-client="ca-pub-3619868657611479" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- google adsense end  -->
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">개발자님 cs 드세요</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/lejewk" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <!-- blog sidbar google ads start-->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog 게시물 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3619868657611479"
     data-ad-slot="3047462172"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
<!-- blog sidbar google ads end-->
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="en">
    <link itemprop="mainEntityOfPage" href="https://lejewk.github.io/vault-get-started/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/11376406?s=460&v=4">
      <meta itemprop="name" content="이재욱이">
      <meta itemprop="description" content="소스코드 파밍중...">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="개발자님 cs 드세요">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          hashicorp Vault 시작 (tutorial)
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-28 09:48:33" itemprop="dateCreated datePublished" datetime="2019-11-28T09:48:33+09:00">2019-11-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-06 16:24:14" itemprop="dateModified" datetime="2020-03-06T16:24:14+09:00">2020-03-06</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="vault-란"><a href="#vault-란" class="headerlink" title="vault 란?"></a>vault 란?</h1><p>토큰, 비밀번호, 인증서 ,암호화 키와 같은 비밀 정보나 민감한 데이터를<br>UI, CLI, HTTP API 를 활용할때<br>안전하게 저장하고 제어할수 있게 해주는 오픈 소스 입니다.<br><a href="https://www.vaultproject.io/">https://www.vaultproject.io/</a></p>
<h1 id="server-실행"><a href="#server-실행" class="headerlink" title="server 실행"></a>server 실행</h1><p>테스트를 위해 -dev 모드로 서버를 실행합니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">vault server -dev</span><br><span class="line">==&gt; Vault server configuration:</span><br><span class="line"> </span><br><span class="line">             Api Address: http://127.0.0.1:8200</span><br><span class="line">                     Cgo: disabled</span><br><span class="line">         Cluster Address: https://127.0.0.1:8201</span><br><span class="line">              Listener 1: tcp (addr: <span class="string">"127.0.0.1:8200"</span>, cluster address: <span class="string">"127.0.0.1:8201"</span>, max_request_duration: <span class="string">"1m30s"</span>, max_request_size: <span class="string">"33554432"</span>, tls: <span class="string">"disabled"</span>)</span><br><span class="line">               Log Level: info</span><br><span class="line">                   Mlock: supported: <span class="literal">false</span>, enabled: <span class="literal">false</span></span><br><span class="line">           Recovery Mode: <span class="literal">false</span></span><br><span class="line">                 Storage: inmem</span><br><span class="line">                 Version: Vault v1.3.0</span><br><span class="line"> </span><br><span class="line">WARNING! dev mode is enabled! In this mode, Vault runs entirely <span class="keyword">in</span>-memory</span><br><span class="line">and starts unsealed with a single unseal key. The root token is already</span><br><span class="line">authenticated to the CLI, so you can immediately begin using Vault.</span><br><span class="line"> </span><br><span class="line">You may need to <span class="built_in">set</span> the following environment variable:</span><br><span class="line"> </span><br><span class="line">PowerShell:</span><br><span class="line">    <span class="variable">$env</span>:VAULT_ADDR=<span class="string">"http://127.0.0.1:8200"</span></span><br><span class="line">cmd.exe:</span><br><span class="line">    <span class="built_in">set</span> VAULT_ADDR=http://127.0.0.1:8200</span><br><span class="line"> </span><br><span class="line">The unseal key and root token are displayed below <span class="keyword">in</span> <span class="keyword">case</span> you want to</span><br><span class="line">seal/unseal the Vault or re-authenticate.</span><br><span class="line"> </span><br><span class="line">Unseal Key: apvm8OuIQeMHgtstu2PB5r7oFkJyyuPTtlz4yxFHa9Y=</span><br><span class="line">Root Token: s.15QsYBSzASsEbHifZrmIMWBH</span><br><span class="line"> </span><br><span class="line">Development mode should NOT be used <span class="keyword">in</span> production installations!</span><br><span class="line"> </span><br><span class="line">==&gt; Vault server started! Log data will stream <span class="keyword">in</span> below:</span><br></pre></td></tr></table></figure>
<h2 id="dev"><a href="#dev" class="headerlink" title="-dev"></a>-dev</h2><ul>
<li>미리 준비된 설정으로 서버를 구동</li>
<li>모든 데이터는 in-memory 저장</li>
<li>암호화</li>
<li>localhost 로 listen 되며 TLS 가 없음</li>
<li>자동 봉인 해제</li>
<li>봉인 해제된 키와 엑세스 토큰을 보여줌</li>
<li>프로덕션 모드에서는 이 옵션 사용을 권장하지 않음.</li>
</ul>
<h2 id="환경변수-등록"><a href="#환경변수-등록" class="headerlink" title="환경변수 등록"></a>환경변수 등록</h2><p>vault CLI 를 사용하기 위해 환경변수 등록이 필요합니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> VAULT_ADDR=<span class="string">'http://127.0.0.1:8200'</span></span><br></pre></td></tr></table></figure>
<p>서버 구동시 출력된 도움말을 읽으면 도움이 될수있습니다.</p>
<p>실행된 서버의 상태를 확인할 수 있습니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ vault status</span><br><span class="line">Key             Value</span><br><span class="line">---             -----</span><br><span class="line">Seal Type       shamir</span><br><span class="line">Initialized     <span class="literal">true</span></span><br><span class="line">Sealed          <span class="literal">false</span></span><br><span class="line">Total Shares    1</span><br><span class="line">Threshold       1</span><br><span class="line">Version         1.3.0</span><br><span class="line">Cluster Name    vault-cluster-a6999d5c</span><br><span class="line">Cluster ID      291371dc-e6a5-42d3-fca7-b2373ff70194</span><br><span class="line">HA Enabled      <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h1 id="vault-와-secret"><a href="#vault-와-secret" class="headerlink" title="vault 와 secret"></a>vault 와 secret</h1><p>vault 의 핵심 기능중 하나는 비밀정보를 안전하게 읽고 쓰는것입니다.<br>vault 에 기록된 비밀정보는 암호화하여 backend 저장소에 저장됩니다.<br>값을 저장소에 전달하기 전에 암호화를 하며,<br>backend 저장소에 저장된 암호화값은 vault 없이는 해독할 수 없습니다.</p>
<h1 id="write-a-secret"><a href="#write-a-secret" class="headerlink" title="write a secret"></a>write a secret</h1><p>비밀정보를 작성해봅니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ vault kv put secret/hello foo=world</span><br><span class="line">Key              Value</span><br><span class="line">---              -----</span><br><span class="line">created_time     2019-11-26T02:39:20.8458832Z</span><br><span class="line">deletion_time    n/a</span><br><span class="line">destroyed        <span class="literal">false</span></span><br><span class="line">version          1</span><br></pre></td></tr></table></figure>
<p>key 값의 접두사가 secret/ 여야만 저장이 됩니다.<br>이 접두사(경로)는 어떤 secrets engine 을 실행시킬지 결정하는 route 역할을 합니다.</p>
<blockquote>
<p>비밀정보를 기록할때는 shell history 에 남기때문에 되도록이면 file 을 통해서 전달될수있도록 하는것이 좋다고 합니다. </p>
</blockquote>
<h1 id="getting-a-secret"><a href="#getting-a-secret" class="headerlink" title="getting a secret"></a>getting a secret</h1><p>비밀정보를 획득해봅니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ vault kv get secret/hello</span><br><span class="line">====== Metadata ======</span><br><span class="line">Key              Value</span><br><span class="line">---              -----</span><br><span class="line">created_time     2019-11-26T02:39:20.8458832Z</span><br><span class="line">deletion_time    n/a</span><br><span class="line">destroyed        <span class="literal">false</span></span><br><span class="line">version          1</span><br><span class="line"> </span><br><span class="line">=== Data ===</span><br><span class="line">Key    Value</span><br><span class="line">---    -----</span><br><span class="line">foo    world</span><br></pre></td></tr></table></figure>
<p>vault 는 저장소로부터 값을 가져올때 복호화하여 가져옵니다.<br>여러가지 메타 데이터가 함께 반환됨을 확인할 수 있습니다.</p>
<h2 id="값-추출"><a href="#값-추출" class="headerlink" title="값 추출"></a>값 추출</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ vault kv get -field=foo secret/hello</span><br><span class="line">world</span><br></pre></td></tr></table></figure>

<h2 id="JSON-output"><a href="#JSON-output" class="headerlink" title="JSON output"></a>JSON output</h2><p>결과데이터의 포맷을 json 으로 출력할수도 있습니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ vault kv get -format=json secret/hello</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"request_id"</span>: <span class="string">"e323e5a1-6ed3-dfcb-d56c-d5d48a5c86be"</span>,</span><br><span class="line">  <span class="string">"lease_id"</span>: <span class="string">""</span>,</span><br><span class="line">  <span class="string">"lease_duration"</span>: 0,</span><br><span class="line">  <span class="string">"renewable"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">"data"</span>: &#123;</span><br><span class="line">    <span class="string">"data"</span>: &#123;</span><br><span class="line">      <span class="string">"foo"</span>: <span class="string">"world"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"metadata"</span>: &#123;</span><br><span class="line">      <span class="string">"created_time"</span>: <span class="string">"2019-11-26T02:39:20.8458832Z"</span>,</span><br><span class="line">      <span class="string">"deletion_time"</span>: <span class="string">""</span>,</span><br><span class="line">      <span class="string">"destroyed"</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">"version"</span>: 1</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"warnings"</span>: null</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="jq-활용"><a href="#jq-활용" class="headerlink" title="jq 활용"></a>jq 활용</h2><p>jq 도구를 통한다면 더 편리하게 원하는 메타정보를 가져올수있습니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ vault kv get -format=json secret/hello | jq -r .data.data.foo</span><br><span class="line">world</span><br></pre></td></tr></table></figure>

<h1 id="deleting-a-secret"><a href="#deleting-a-secret" class="headerlink" title="deleting a secret"></a>deleting a secret</h1><p>저장된 비밀정보를 삭제할 수 있습니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ vault kv delete secret/hello</span><br><span class="line">Success! Data deleted (<span class="keyword">if</span> it existed) at: secret/hello</span><br></pre></td></tr></table></figure>

<h1 id="secrets-engines"><a href="#secrets-engines" class="headerlink" title="secrets engines"></a>secrets engines</h1><p>secret/ 접두사는 kv 엔진을 실행하는 route 역할을 합니다.</p>
<blockquote>
<p>kv 는 가장 기본적인 데이터 관리 엔진 입니다.</p>
</blockquote>
<p><code>foo/</code> 아래와 같은 접두사는 어떻게 동작할까요?</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ vault write foo/bar a=b</span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">* no handler <span class="keyword">for</span> route <span class="string">'foo/bar'</span></span><br></pre></td></tr></table></figure>
<p>결과가 말해주듯 연결된 핸들러가 없다는 메시지를 반환합니다.<br>vault 는 수많은 <code>secrets engine</code> 이 있습니다.<br><a href="https://www.vaultproject.io/docs/secrets/index.html">https://www.vaultproject.io/docs/secrets/index.html</a></p>
<h2 id="secrets-engine-활성화"><a href="#secrets-engine-활성화" class="headerlink" title="secrets engine 활성화"></a>secrets engine 활성화</h2><p>사용자가 원하는 임의의 경로에 vault 에서 제공하는 secrets engine 을 연결할수 있습니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ vault secrets <span class="built_in">enable</span> -path=wook kv</span><br><span class="line">Success! Enabled the kv secrets engine at: wook/</span><br></pre></td></tr></table></figure>
<p>이 설정은 <code>wook/ 접두사로 시작되는 경로는 kv 엔진을 사용한다</code> 라는 의미입니다.<br>실제로 그런지 secrets list 를 확인해보면 알 수 있습니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ vault secrets list</span><br><span class="line">Path          Type         Accessor              Description</span><br><span class="line">----          ----         --------              -----------</span><br><span class="line">cubbyhole/    cubbyhole    cubbyhole_9e279c40    per-token private secret storage</span><br><span class="line">identity/     identity     identity_8959bd02     identity store</span><br><span class="line">secret/       kv           kv_e56557df           key/value secret storage</span><br><span class="line">sys/          system       system_dbd69f9d       system endpoints used <span class="keyword">for</span> control, policy and debugging</span><br><span class="line">wook/         kv           kv_e01b755a           n/a</span><br></pre></td></tr></table></figure>

<p>이제 임의로 지정한 경로를 통해 secrets engine 을 활용한 데이터를 기록하고 확인해봅니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ vault write wook/hello name=wook</span><br><span class="line">Success! Data written to: wook/hello</span><br><span class="line"> </span><br><span class="line">$ vault write wook/pc cpu=amd</span><br><span class="line">Success! Data written to: wook/pc</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ vault list wook</span><br><span class="line">Keys</span><br><span class="line">----</span><br><span class="line">hello</span><br><span class="line">pc</span><br></pre></td></tr></table></figure>

<h2 id="secrets-engine-비활성화"><a href="#secrets-engine-비활성화" class="headerlink" title="secrets engine 비활성화"></a>secrets engine 비활성화</h2><p>secrests engine 에 연결된 임의의 경로를 비활성화 시킬수도 있습니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ vault secrets <span class="built_in">disable</span> wook/</span><br><span class="line">Success! Disabled the secrets engine (<span class="keyword">if</span> it existed) at: wook/</span><br></pre></td></tr></table></figure>
<p>비활성화 이후에는 wook/ 경로를 더이상 확인할 수 없는것을 볼수있습니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ vault list wook</span><br><span class="line">No value found at wook/</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ vault secrets list</span><br><span class="line">Path          Type         Accessor              Description</span><br><span class="line">----          ----         --------              -----------</span><br><span class="line">cubbyhole/    cubbyhole    cubbyhole_9e279c40    per-token private secret storage</span><br><span class="line">identity/     identity     identity_8959bd02     identity store</span><br><span class="line">secret/       kv           kv_e56557df           key/value secret storage</span><br><span class="line">sys/          system       system_dbd69f9d       system endpoints used <span class="keyword">for</span> control, policy and debugging</span><br></pre></td></tr></table></figure>

<h2 id="다른-환경과-연동"><a href="#다른-환경과-연동" class="headerlink" title="다른 환경과 연동"></a>다른 환경과 연동</h2><p>vault 에서 제공하는 secrets engine 를 활용하여 read / write 와 같이 추상화된 인터페이스를 통해 다른 환경과 연동이 가능합니다.</p>
<p><strong>예를 들면</strong></p>
<ul>
<li>dynamic SQL user creation</li>
<li>AWS IAM</li>
<li>등…</li>
</ul>
<p>앞으로 등장할 내용은 정적 비밀정보 처리가 아닌 동적 처리방식을 다룹니다.</p>
<h1 id="dynamic-secrets-동적-비밀정보"><a href="#dynamic-secrets-동적-비밀정보" class="headerlink" title="dynamic secrets (동적 비밀정보)"></a>dynamic secrets (동적 비밀정보)</h1><p>앞절에서 소개드린 kv 는 vault 가 기본적으로 제공하는 비밀정보 관리 도구입니다.<br>정적인 데이터를 다루는데 자주 사용했지만, 이것이 vault 의 핵심기능의 전부는 아닙니다.</p>
<p>dynamic secrets 는 kv 와 달리 엑세스 시점에 비밀정보가 생성됩니다.<br>즉, 엑세스 전까지는 비밀정보가 존재하지 않는다는 말입니다.<br>그래서 서로 다른 클라이언트간에 비밀정보 탈취에 대한 염려가 없습니다.<br>또한 vault 에는 사용 이후 dynamic secrets 을 해지하는 메커니즘이 내장되어있습니다.<br>따라서 비밀정보 유지기간을 최소화 하고 있습니다.</p>
<p>정리하자면,<br>본래 secret 정보를 app 자체가 갖고있거나 외부 저장소로부터 획득하여 사용했다면,<br>vault 를 사용할 경우 secret 정보를 동적으로 생성하고 app 은 이를 사용하다가 필요가 없을경우 폐기 또는 vault 에 의해서 스스로 삭제될수있다고 할수있습니다. app 은 secret 정보가 필요할때마다 vault 를 이용하면 됩니다.</p>
<h2 id="AWS-secret-테스트"><a href="#AWS-secret-테스트" class="headerlink" title="AWS secret 테스트"></a>AWS secret 테스트</h2><p>vault 를 활용해 AWS 의 IAM 유저를 동적으로 생성해보겠습니다.<br>:star:테스트 전에 AWS 에 가입하여 root key 를 확보해두셔야 합니다.</p>
<h3 id="AWS-secrets-engine-활성화"><a href="#AWS-secrets-engine-활성화" class="headerlink" title="AWS secrets engine 활성화"></a>AWS secrets engine 활성화</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ vault secrets <span class="built_in">enable</span> -path=aws aws</span><br><span class="line">Success! Enabled the aws secrets engine at: aws/</span><br></pre></td></tr></table></figure>

<h3 id="config-작성"><a href="#config-작성" class="headerlink" title="config 작성"></a>config 작성</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ vault write aws/config/root \</span><br><span class="line">    access_key=A---ENIQ \</span><br><span class="line">    secret_key=z1P-----------UW+eB</span><br><span class="line">Success! Data written to: aws/config/root</span><br></pre></td></tr></table></figure>

<h3 id="role-작성"><a href="#role-작성" class="headerlink" title="role 작성"></a>role 작성</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ vault write aws/roles/my-role \</span><br><span class="line">    credential_type=iam_user \</span><br><span class="line">    policy_document=-&lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">  <span class="string">"Statement"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">      <span class="string">"Action"</span>: <span class="string">"ec2:*"</span>,</span><br><span class="line">      <span class="string">"Resource"</span>: <span class="string">"*"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">Success! Data written to: aws/roles/my-role</span><br></pre></td></tr></table></figure>
<p>이 롤은 AWS 에서 제공하는 문서를 참고하여 다양하게 작성할 수 있습니다.<br><a href="https://docs.aws.amazon.com/ko_kr/apigateway/latest/developerguide/permissions.html">https://docs.aws.amazon.com/ko_kr/apigateway/latest/developerguide/permissions.html</a></p>
<h3 id="secret-생성"><a href="#secret-생성" class="headerlink" title="secret 생성"></a>secret 생성</h3><p>주입된 롤에의해 IAM 유저를 생성합니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ vault <span class="built_in">read</span> aws/creds/my-role</span><br><span class="line">Key                Value</span><br><span class="line">---                -----</span><br><span class="line">lease_id           aws/creds/my-role/0bce07---------ff22106e</span><br><span class="line">lease_duration     768h</span><br><span class="line">lease_renewable    <span class="literal">true</span></span><br><span class="line">access_key         AKIA-------CTZQ</span><br><span class="line">secret_key         WWeSnj0------------mk/8FyTg</span><br><span class="line">security_token     &lt;nil&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>lease_id 는 중요한 정보이므로 따로 정리해둘 필요가 있습니다.</p>
</blockquote>
<p>저는 두번의 실행을 통해 IAM 유저 2개를 등록했습니다.<br>AWS 의 IAM 을통해 생성된 유저를 확인할 수 있습니다.<br><img src="https://user-images.githubusercontent.com/11376406/69770027-b66ec480-11ca-11ea-9cfa-7647707a0715.png" alt=""></p>
<h3 id="secret-갱신-amp-획득"><a href="#secret-갱신-amp-획득" class="headerlink" title="secret 갱신 &amp; 획득"></a>secret 갱신 &amp; 획득</h3><p><code>lease_id</code> 를 통해 client 는 secret 을 갱신함과 동시에 재획득이 가능합니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ vault lease renew aws/creds/my-role/0bce07---------ff22106e</span><br><span class="line">WARNING! The following warnings were returned from Vault:</span><br><span class="line"> </span><br><span class="line">  * TTL of <span class="string">"768h0m0s"</span> exceeded the effective max_ttl of <span class="string">"751h47m55s"</span>; TTL</span><br><span class="line">  value is capped accordingly</span><br><span class="line"> </span><br><span class="line">Key                Value</span><br><span class="line">---                -----</span><br><span class="line">lease_id           aws/creds/my-role/0bce07---------ff22106e</span><br><span class="line">lease_duration     751h47m55s</span><br><span class="line">lease_renewable    <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="secret-제거"><a href="#secret-제거" class="headerlink" title="secret 제거"></a>secret 제거</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ vault lease revoke aws/creds/my-role/0bce07---------ff22106e</span><br><span class="line">Success! Revoked lease: aws/creds/my-role/0bce07---------ff22106e</span><br></pre></td></tr></table></figure>

<p>AWS 의 IAM 을통해 삭제된 유저를 확인할 수 있습니다.<br><img src="https://user-images.githubusercontent.com/11376406/69770026-b66ec480-11ca-11ea-8579-15e5de885c12.png" alt=""></p>
<h2 id="MYSQL-dynamic-sql-user-creation-테스트"><a href="#MYSQL-dynamic-sql-user-creation-테스트" class="headerlink" title="MYSQL dynamic sql user creation 테스트"></a>MYSQL dynamic sql user creation 테스트</h2><p>이번엔 동적으로 mysql 의 유저를 동적으로 생성해보겠습니다.<br>:star: 로컬PC 에 3306 port 로 mysql 또는 mariaDB 서비스가 동작되고있어야 합니다.</p>
<h3 id="database-secrets-engine-활성화"><a href="#database-secrets-engine-활성화" class="headerlink" title="database secrets engine 활성화"></a>database secrets engine 활성화</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ vault secrets <span class="built_in">enable</span> database</span><br><span class="line">Success! Enabled the database secrets engine at: database/</span><br></pre></td></tr></table></figure>
<p>AWS 에서는 path 경로를 지정했지만 vault 가 제공하는 기본룰에 따라 쉽게 활성화할 수 있게 해줍니다.</p>
<h3 id="config-작성-1"><a href="#config-작성-1" class="headerlink" title="config 작성"></a>config 작성</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ vault write database/config/my-mysql-database \</span><br><span class="line">    plugin_name=mysql-database-plugin \</span><br><span class="line">    connection_url=<span class="string">"&#123;&#123;username&#125;&#125;:&#123;&#123;password&#125;&#125;@tcp(127.0.0.1:3306)/"</span> \</span><br><span class="line">    allowed_roles=<span class="string">"my-role"</span> \</span><br><span class="line">    username=<span class="string">"root"</span> \</span><br><span class="line">    password=<span class="string">"password"</span></span><br></pre></td></tr></table></figure>

<h3 id="role-작성-1"><a href="#role-작성-1" class="headerlink" title="role 작성"></a>role 작성</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ vault write database/roles/my-role \</span><br><span class="line">    db_name=my-mysql-database \</span><br><span class="line">    creation_statements=<span class="string">"CREATE USER '&#123;&#123;name&#125;&#125;'@'%' IDENTIFIED BY '&#123;&#123;password&#125;&#125;';GRANT SELECT ON *.* TO '&#123;&#123;name&#125;&#125;'@'%';"</span> \</span><br><span class="line">    default_ttl=<span class="string">"1h"</span> \</span><br><span class="line">    max_ttl=<span class="string">"24h"</span></span><br><span class="line">Success! Data written to: database/roles/my-role</span><br></pre></td></tr></table></figure>

<h3 id="secret-생성-1"><a href="#secret-생성-1" class="headerlink" title="secret 생성"></a>secret 생성</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ vault <span class="built_in">read</span> database/creds/my-role</span><br><span class="line">Key                Value</span><br><span class="line">---                -----</span><br><span class="line">lease_id           database/creds/my-role/q1c4Aj0tnafhRm4YxGZsOzeD</span><br><span class="line">lease_duration     1h</span><br><span class="line">lease_renewable    <span class="literal">true</span></span><br><span class="line">password           A1a-0uwe7ZxT4pU3JJAR</span><br><span class="line">username           v-root-my-role-2OMpLHt7ZSwdbRg9F</span><br></pre></td></tr></table></figure>
<p>지정된 롤에 맞춰 동적으로 mysql 의 user가 생성된것을 볼수있습니다.<br><img src="https://user-images.githubusercontent.com/11376406/69770332-f3878680-11cb-11ea-8c06-3d03c5299aa8.png" alt=""></p>
<h1 id="authentication-인증"><a href="#authentication-인증" class="headerlink" title="authentication (인증)"></a>authentication (인증)</h1><p>vault 의 기능을 사용하기위해서는 원래 인증절차가 필요합니다.<br>위는 <code>-dev</code> 모드를 사용했기때문에 위에서는 자동으로 root token 을 통해 테스트 했던것입니다.</p>
<p>vault 인증은 token 을 통해 처리됩니다.</p>
<h2 id="token-생성"><a href="#token-생성" class="headerlink" title="token 생성"></a>token 생성</h2><p>token 생성은 부모 token 을 기반으로 자식 token 을 생성합니다.<br>또는 별도의 정책이 부여된 token 을 발행할수도 있습니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ vault token create</span><br><span class="line">Key                  Value</span><br><span class="line">---                  -----</span><br><span class="line">token                s.0LIcD95AWk9Yyg4QemsoieCN</span><br><span class="line">token_accessor       R3sXav3nhCRMLNjQYuKEtuAf</span><br><span class="line">token_duration       ∞</span><br><span class="line">token_renewable      <span class="literal">false</span></span><br><span class="line">token_policies       [<span class="string">"root"</span>]</span><br><span class="line">identity_policies    []</span><br><span class="line">policies             [<span class="string">"root"</span>]</span><br></pre></td></tr></table></figure>

<h2 id="token-삭제"><a href="#token-삭제" class="headerlink" title="token 삭제"></a>token 삭제</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ vault token revoke s.0LIcD95AWk9Yyg4QemsoieCN</span><br><span class="line">Success! Revoked token (<span class="keyword">if</span> it existed)</span><br></pre></td></tr></table></figure>

<h2 id="token-을-통한-인증"><a href="#token-을-통한-인증" class="headerlink" title="token 을 통한 인증"></a>token 을 통한 인증</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 토큰 생성</span></span><br><span class="line">$ vault token create</span><br><span class="line">Key                  Value</span><br><span class="line">---                  -----</span><br><span class="line">token                s.mTG4kSzyKbQjiGhq1cEMFqFs</span><br><span class="line">token_accessor       n7KOg3SDRiIZq6xlsgQbWW9m</span><br><span class="line">token_duration       ∞</span><br><span class="line">token_renewable      <span class="literal">false</span></span><br><span class="line">token_policies       [<span class="string">"root"</span>]</span><br><span class="line">identity_policies    []</span><br><span class="line">policies             [<span class="string">"root"</span>] </span><br><span class="line"> </span><br><span class="line"><span class="comment"># 인증</span></span><br><span class="line">$ vault login s.mTG4kSzyKbQjiGhq1cEMFqFs</span><br><span class="line">Success! You are now authenticated. The token information displayed below</span><br><span class="line">is already stored <span class="keyword">in</span> the token helper. You <span class="keyword">do</span> NOT need to run <span class="string">"vault login"</span></span><br><span class="line">again. Future Vault requests will automatically use this token.</span><br><span class="line"> </span><br><span class="line">Key                  Value</span><br><span class="line">---                  -----</span><br><span class="line">token                s.mTG4kSzyKbQjiGhq1cEMFqFs</span><br><span class="line">token_accessor       n7KOg3SDRiIZq6xlsgQbWW9m</span><br><span class="line">token_duration       ∞</span><br><span class="line">token_renewable      <span class="literal">false</span></span><br><span class="line">token_policies       [<span class="string">"root"</span>]</span><br><span class="line">identity_policies    []</span><br><span class="line">policies             [<span class="string">"root"</span>]</span><br></pre></td></tr></table></figure>

<p>:warning: 실제로 운영자가 이렇게 토큰을 사용하여 클라이언트에 지급하는것은 좋지 못하다고 합니다.<br>따라서 다양한 인증 방식을 통해 토큰을 발행받아 사용하는 방식을 제공하고 있습니다.</p>
<h1 id="다양한-인증-방식"><a href="#다양한-인증-방식" class="headerlink" title="다양한 인증 방식"></a>다양한 인증 방식</h1><p>vault 는 제 3 서비스가 제공하는 방식을 통해 인증을 처리할수도 있습니다.</p>
<h2 id="github-인증-테스트"><a href="#github-인증-테스트" class="headerlink" title="github 인증 테스트"></a>github 인증 테스트</h2><p>github 의 organization 및 개별 token 을 활용한 인증 방식을 테스트 합니다.</p>
<h3 id="github-설정"><a href="#github-설정" class="headerlink" title="github 설정"></a>github 설정</h3><ol>
<li>organization 구성<br><a href="https://github.com/settings/organizations">https://github.com/settings/organizations</a></li>
<li>Personal access tokens 등록<br><a href="https://github.com/settings/tokens">https://github.com/settings/tokens</a><br>:star:토큰 설정시 user 또는 read.org 권한을 넣어주셔야 합니다.</li>
</ol>
<h3 id="github-인증-활성화"><a href="#github-인증-활성화" class="headerlink" title="github 인증 활성화"></a>github 인증 활성화</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ vault auth <span class="built_in">enable</span> -path=github github</span><br><span class="line">Success! Enabled github auth method at: github/</span><br></pre></td></tr></table></figure>

<h3 id="github-인증-설정"><a href="#github-인증-설정" class="headerlink" title="github 인증 설정"></a>github 인증 설정</h3><p>인증 범위는 github 의 lighten518-til 조직(github 에서 만든) 내의 유저로 설정합니다.<br>그 다음 명령어는 my-team 의 모든 사용자에게 default 와 my-policy 정책을 매핑하게 합니다.</p>
<p>:star:아직 my-policy 정책에 대한 정보를 구성하지 않았으므로 정책에 대하서는 여기서는 일단 무시하셔도 좋습니다</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ vault write auth/github/config organization=lighten518-til</span><br><span class="line">Success! Data written to: auth/github/config</span><br><span class="line"> </span><br><span class="line">$ vault write auth/github/map/teams/my-team value=default,my-policy</span><br><span class="line">Success! Data written to: auth/github/map/teams/my-team</span><br></pre></td></tr></table></figure>

<h3 id="등록된-인증-확인"><a href="#등록된-인증-확인" class="headerlink" title="등록된 인증 확인"></a>등록된 인증 확인</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ vault auth list</span><br><span class="line">Path       Type      Accessor                Description</span><br><span class="line">----       ----      --------                -----------</span><br><span class="line">github/    github    auth_github_588abfc9    n/a</span><br><span class="line">token/     token     auth_token_e9c048f1     token based credentials</span><br></pre></td></tr></table></figure>

<h3 id="인증"><a href="#인증" class="headerlink" title="인증"></a>인증</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ vault login -method=github token=e5f6ecb31---------f2b43f181f2</span><br><span class="line">Success! You are now authenticated. The token information displayed below</span><br><span class="line">is already stored <span class="keyword">in</span> the token helper. You <span class="keyword">do</span> NOT need to run <span class="string">"vault login"</span></span><br><span class="line">again. Future Vault requests will automatically use this token.</span><br><span class="line"> </span><br><span class="line">Key                    Value</span><br><span class="line">---                    -----</span><br><span class="line">token                  s.1Gzm----gJa7qlW5</span><br><span class="line">token_accessor         3g7h8px---UKiVMQXzsMO</span><br><span class="line">token_duration         768h</span><br><span class="line">token_renewable        <span class="literal">true</span></span><br><span class="line">token_policies         [<span class="string">"default"</span>]</span><br><span class="line">identity_policies      []</span><br><span class="line">policies               [<span class="string">"default"</span>]</span><br><span class="line">token_meta_org         lighten518-til</span><br><span class="line">token_meta_username    lejewk</span><br></pre></td></tr></table></figure>
<p>:heavy_check_mark: vault 에 로그인 되었습니다!</p>
<p>이어서 <code>policy(정책)</code> 에 대해 보겠습니다.</p>
<h1 id="polices-정책"><a href="#polices-정책" class="headerlink" title="polices (정책)"></a>polices (정책)</h1><p>정책이란 vault 에 로그인한 유저가 어떤 기능을 사용할수있느냐를 정의하는것입니다.<br>이것을 Authorization (인가) 에 대한 부분으로 인지하셔도 좋습니다.<br>인증은 각각의 인증방법(github, 기타 등등…) 에 따라가고, 인가는 vault 가 정의한 정책에 매핑합니다.</p>
<p>vault 는 삭제 불가능한 몇가지 기본정책을 제공합니다.</p>
<ul>
<li><code>root</code>: 관리자</li>
<li><code>default</code>: 기본기능</li>
</ul>
<h2 id="policy-format"><a href="#policy-format" class="headerlink" title="policy format"></a>policy format</h2><p>hcl 문법으로 작성한다고 합니다.<br><a href="https://github.com/hashicorp/hcl">https://github.com/hashicorp/hcl</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /my-policy.hcl</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Normal servers have version 1 of KV mounted by default, so will need these</span></span><br><span class="line"><span class="comment"># paths:</span></span><br><span class="line">path <span class="string">"secret/*"</span> &#123;</span><br><span class="line">  capabilities = [<span class="string">"create"</span>]</span><br><span class="line">&#125;</span><br><span class="line">path <span class="string">"secret/foo"</span> &#123;</span><br><span class="line">  capabilities = [<span class="string">"read"</span>]</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Dev servers have version 2 of KV mounted by default, so will need these</span></span><br><span class="line"><span class="comment"># paths:</span></span><br><span class="line">path <span class="string">"secret/data/*"</span> &#123;</span><br><span class="line">  capabilities = [<span class="string">"create"</span>]</span><br><span class="line">&#125;</span><br><span class="line">path <span class="string">"secret/data/foo"</span> &#123;</span><br><span class="line">  capabilities = [<span class="string">"read"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>secret/ 의 모든 경로에 쓰기가 가능하지만 secret/foo 는 읽기만 가능하다</code><br>라는 정책입니다.</p>
<p>:star: vault 는 경로 기반 secrets engine 사용 패턴이므로 경로에 대해서 정책을 정하여 엄격하게 관리할 수 있습니다.</p>
<h3 id="fmt"><a href="#fmt" class="headerlink" title="fmt"></a>fmt</h3><p>vault 는 policy 의 포맷에 대해 체크해주며 오류 발생시 error를 발생해주는 도구가 있습니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ vault policy fmt my-policy.hcl</span><br><span class="line">Success! Formatted policy: my-policy.hcl</span><br></pre></td></tr></table></figure>

<h2 id="writing-the-police"><a href="#writing-the-police" class="headerlink" title="writing the police"></a>writing the police</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ vault policy write my-policy my-policy.hcl</span><br><span class="line">Success! Uploaded policy: my-policy</span><br></pre></td></tr></table></figure>

<h2 id="list-of-policies"><a href="#list-of-policies" class="headerlink" title="list of policies"></a>list of policies</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ vault policy list</span><br><span class="line">default</span><br><span class="line">my-policy</span><br><span class="line">root</span><br></pre></td></tr></table></figure>

<h2 id="view-contents-of-policy"><a href="#view-contents-of-policy" class="headerlink" title="view contents of policy"></a>view contents of policy</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ vault policy <span class="built_in">read</span> my-policy</span><br><span class="line"><span class="comment"># Normal servers have version 1 of KV mounted by default, so will need these</span></span><br><span class="line"><span class="comment"># paths:</span></span><br><span class="line">path <span class="string">"secret/*"</span> &#123;</span><br><span class="line">  capabilities = [<span class="string">"create"</span>]</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">path <span class="string">"secret/foo"</span> &#123;</span><br><span class="line">  capabilities = [<span class="string">"read"</span>]</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Dev servers have version 2 of KV mounted by default, so will need these</span></span><br><span class="line"><span class="comment"># paths:</span></span><br><span class="line">path <span class="string">"secret/data/*"</span> &#123;</span><br><span class="line">  capabilities = [<span class="string">"create"</span>]</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">path <span class="string">"secret/data/foo"</span> &#123;</span><br><span class="line">  capabilities = [<span class="string">"read"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="policy-test"><a href="#policy-test" class="headerlink" title="policy test"></a>policy test</h2><h3 id="정책이-반영된-toke-발행"><a href="#정책이-반영된-toke-발행" class="headerlink" title="정책이 반영된 toke 발행"></a>정책이 반영된 toke 발행</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ vault token create -policy=my-policy</span><br><span class="line">Key                  Value</span><br><span class="line">---                  -----</span><br><span class="line">token                s.vchcnwzB3pI55ja711oaXCwB</span><br><span class="line">token_accessor       SK2qM9OsvruupUlobYL5YBj0</span><br><span class="line">token_duration       768h</span><br><span class="line">token_renewable      <span class="literal">true</span></span><br><span class="line">token_policies       [<span class="string">"default"</span> <span class="string">"my-policy"</span>]</span><br><span class="line">identity_policies    []</span><br><span class="line">policies             [<span class="string">"default"</span> <span class="string">"my-policy"</span>]</span><br></pre></td></tr></table></figure>

<h3 id="해당-token-으로-인증"><a href="#해당-token-으로-인증" class="headerlink" title="해당 token 으로 인증"></a>해당 token 으로 인증</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ vault login s.vchcnwzB3pI55ja711oaXCwB</span><br><span class="line">Success! You are now authenticated. The token information displayed below</span><br><span class="line">is already stored <span class="keyword">in</span> the token helper. You <span class="keyword">do</span> NOT need to run <span class="string">"vault login"</span></span><br><span class="line">again. Future Vault requests will automatically use this token.</span><br><span class="line"> </span><br><span class="line">Key                  Value</span><br><span class="line">---                  -----</span><br><span class="line">token                s.vchcnwzB3pI55ja711oaXCwB</span><br><span class="line">token_accessor       SK2qM9OsvruupUlobYL5YBj0</span><br><span class="line">token_duration       767h59m47s</span><br><span class="line">token_renewable      <span class="literal">true</span></span><br><span class="line">token_policies       [<span class="string">"default"</span> <span class="string">"my-policy"</span>]</span><br><span class="line">identity_policies    []</span><br><span class="line">policies             [<span class="string">"default"</span> <span class="string">"my-policy"</span>]</span><br></pre></td></tr></table></figure>

<h3 id="kv-쓰기-테스트"><a href="#kv-쓰기-테스트" class="headerlink" title="kv 쓰기 테스트"></a>kv 쓰기 테스트</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ vault kv put secret/<span class="built_in">test</span> name=wook</span><br><span class="line">Key              Value</span><br><span class="line">---              -----</span><br><span class="line">created_time     2019-11-27T07:45:44.5049062Z</span><br><span class="line">deletion_time    n/a</span><br><span class="line">destroyed        <span class="literal">false</span></span><br><span class="line">version          1</span><br><span class="line"> </span><br><span class="line"><span class="comment"># foo 는 쓰기에 대한 권한이 없어 실패</span></span><br><span class="line">$ vault kv put secret/foo age=10</span><br><span class="line">Error writing data to secret/data/foo: Error making API request.</span><br><span class="line"> </span><br><span class="line">URL: PUT http://127.0.0.1:8200/v1/secret/data/foo</span><br><span class="line">Code: 403. Errors:</span><br><span class="line"> </span><br><span class="line">* 1 error occurred:</span><br><span class="line">        * permission denied</span><br></pre></td></tr></table></figure>

<h1 id="deploy-vault"><a href="#deploy-vault" class="headerlink" title="deploy vault"></a>deploy vault</h1><p>배포 환경에서는 어떻게 설정되야할까요?<br>개발모드에서는 -dev 를 통해 미리 준비된 설정을 사용했다면,<br>이제는 직접 설정을 구성하여  vault 를 실행해야 합니다.</p>
<h2 id="server-설정"><a href="#server-설정" class="headerlink" title="server 설정"></a>server 설정</h2><p>hcl 문법으로 실행시 필요한 설정 정보를 작성합니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /config.hcl</span></span><br><span class="line"></span><br><span class="line">ui = <span class="literal">true</span></span><br><span class="line"> </span><br><span class="line">storage <span class="string">"consul"</span> &#123;</span><br><span class="line">  address = <span class="string">"127.0.0.1:8500"</span></span><br><span class="line">  path    = <span class="string">"vault/"</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">listener <span class="string">"tcp"</span> &#123;</span><br><span class="line"> address     = <span class="string">"127.0.0.1:8200"</span></span><br><span class="line"> tls_disable = 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ui</code> 는 vault 가 제공하는 웹 gui tool 을 활성화 합니다.<br><a href="http://127.0.0.1:8200/ui">http://127.0.0.1:8200/ui</a></p>
<p><code>storage</code> 는 vault 의 데이터를 저장할 backend 를 지정합니다.<br>consul 을 지정했고 따라서 consul agent server 가 동작되야 합니다.<br><a href="https://www.consul.io/">https://www.consul.io/</a> 참고</p>
<p><code>listener</code> 는 vault 의 API 를 사용할 endpoint 로 보시면 됩니다.</p>
<p>개발 테스트이므로 환경변수에 vault 주소를 등록해주셔야 합니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> VAULT_ADDR=http://127.0.0.1:8200</span><br></pre></td></tr></table></figure>

<h2 id="server-start-with-config-hcl"><a href="#server-start-with-config-hcl" class="headerlink" title="server start with config.hcl"></a>server start with config.hcl</h2><p>먼저 consul 을 실행시킵니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul agent -dev</span><br></pre></td></tr></table></figure>

<p>이후 vault 를 설정파일과 함께 실행합니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ vault server -config=config.hcl</span><br><span class="line">WARNING! mlock is not supported on this system! An mlockall(2)-like syscall to</span><br><span class="line">prevent memory from being swapped to disk is not supported on this system. For</span><br><span class="line">better security, only run Vault on systems <span class="built_in">where</span> this call is supported. If</span><br><span class="line">you are running Vault <span class="keyword">in</span> a Docker container, provide the IPC_LOCK <span class="built_in">cap</span> to the</span><br><span class="line">container.</span><br><span class="line">==&gt; Vault server configuration:</span><br><span class="line"> </span><br><span class="line">             Api Address: http://127.0.0.1:8200</span><br><span class="line">                     Cgo: disabled</span><br><span class="line">         Cluster Address: https://127.0.0.1:8201</span><br><span class="line">              Listener 1: tcp (addr: <span class="string">"127.0.0.1:8200"</span>, cluster address: <span class="string">"127.0.0.1:8201"</span>, max_request_duration: <span class="string">"1m30s"</span>, max_request_size: <span class="string">"33554432"</span>, tls: <span class="string">"disabled"</span>)</span><br><span class="line">               Log Level: info</span><br><span class="line">                   Mlock: supported: <span class="literal">false</span>, enabled: <span class="literal">false</span></span><br><span class="line">           Recovery Mode: <span class="literal">false</span></span><br><span class="line">                 Storage: consul (HA available)</span><br><span class="line">                 Version: Vault v1.3.0</span><br><span class="line"> </span><br><span class="line">==&gt; Vault server started! Log data will stream <span class="keyword">in</span> below:</span><br></pre></td></tr></table></figure>

<h2 id="vault-초기화"><a href="#vault-초기화" class="headerlink" title="vault 초기화"></a>vault 초기화</h2><p>-dev 모드와 다르게 vault 를 사용하려면 초기화가 필요합니다.<br>:warning: 초기화 없이 cli 를 사용하게 될경우 봉인 오류가 발생됩니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ vault kv put secret/wook a=b</span><br><span class="line">Error making API request.</span><br><span class="line"> </span><br><span class="line">URL: GET http://127.0.0.1:8200/v1/sys/internal/ui/mounts/secret/wook</span><br><span class="line">Code: 503. Errors:</span><br><span class="line"> </span><br><span class="line">* Vault is sealed</span><br></pre></td></tr></table></figure>

<p>초기화는 backend 서버가 시작된 경우 1회만 실행하면 됩니다.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ vault operator init</span><br><span class="line">Unseal Key 1: 6VoUsGk140OnDi2Z3OcXBJyr/cS3Zv+gnAGDOteiOeFO</span><br><span class="line">Unseal Key 2: 4wrk+3AX7Z39BKSZcAsGNO+5Zsn1s4MjWK/2N5o0Tc7U</span><br><span class="line">Unseal Key 3: HIqhJ9p5rRaYjN8Rjhm6bDMO+zVlyy3Tc2HD+0MeY6dJ</span><br><span class="line">Unseal Key 4: hkmXS/d6Wdmg4xkyJVLlWJP8L8uEKhmKbOH0nOm1PNfE</span><br><span class="line">Unseal Key 5: /GJp/G+7aoMjTqarPqmxYtN+oSEw38C4kWZNQNuw6zsf</span><br><span class="line">  </span><br><span class="line">Initial Root Token: s.eRWvoMPfKdxk2ja7kqIlSuR6</span><br><span class="line">  </span><br><span class="line">Vault initialized with 5 key shares and a key threshold of 3. Please securely</span><br><span class="line">distribute the key shares printed above. When the Vault is re-sealed,</span><br><span class="line">restarted, or stopped, you must supply at least 3 of these keys to unseal it</span><br><span class="line">before it can start servicing requests.</span><br><span class="line">  </span><br><span class="line">Vault does not store the generated master key. Without at least 3 key to</span><br><span class="line">reconstruct the master key, Vault will remain permanently sealed!</span><br><span class="line">  </span><br><span class="line">It is possible to generate new unseal keys, provided you have a quorum of</span><br><span class="line">existing unseal keys shares. See <span class="string">"vault operator rekey"</span> <span class="keyword">for</span> more information.</span><br></pre></td></tr></table></figure>

<p>:star:이때 생산된 봉인 해제키와 루트 토큰을 잘 갖고 계셔야합니다.<br>이 키또한 관리대상이므로 vault’s PGP 또는 keybase.io 를 활용한다고 합니다.</p>
<h2 id="sear-unseal-봉인-해제"><a href="#sear-unseal-봉인-해제" class="headerlink" title="sear / unseal (봉인 / 해제)"></a>sear / unseal (봉인 / 해제)</h2><p>초기화된 모든 vault 서버는 봉인된 상태로 시작합니다.<br>vault 는 물리서버에 접근할수있으나 해독 방법을 모르기때문에 데이터를 읽을수는 없습니다.<br>vault 가 데이터를 해독하는 방법을 가르치는 과정을 vault unseal 이라고 합니다.</p>
<p>vault 가 시작될때마다 unseal 을 해야합니다.<br>이 과정은 API 와 CLI 를 통해 수행할 수 있습니다.</p>
<p>unseal 을 하려면 임계값 개수(최소) 의 unseal key 를 소유하고 있어야 합니다. (3개)<br><code>Vault initialized with 5 key shares and a key threshold of 3</code></p>
<p><strong>첫번째 해제</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ vault operator unseal 6VoUsGk140OnDi2Z3OcXBJyr/cS3Zv+gnAGDOteiOeFO</span><br><span class="line">Key                Value</span><br><span class="line">---                -----</span><br><span class="line">Seal Type          shamir</span><br><span class="line">Initialized        <span class="literal">true</span></span><br><span class="line">Sealed             <span class="literal">true</span></span><br><span class="line">Total Shares       5</span><br><span class="line">Threshold          3</span><br><span class="line">Unseal Progress    1/3</span><br><span class="line">Unseal Nonce       0195ceed-69fd-dd26-cb82-604952a572ae</span><br><span class="line">Version            1.3.0</span><br><span class="line">HA Enabled         <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p><strong>두번째, 세번째 해제</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ vault operator unseal hkmXS/d6Wdmg4xkyJVLlWJP8L8uEKhmKbOH0nOm1PNfE</span><br><span class="line">$ vault operator unseal 4wrk+3AX7Z39BKSZcAsGNO+5Zsn1s4MjWK/2N5o0Tc7U</span><br><span class="line">Key                    Value</span><br><span class="line">---                    -----</span><br><span class="line">Seal Type              shamir</span><br><span class="line">Initialized            <span class="literal">true</span></span><br><span class="line">Sealed                 <span class="literal">false</span> <span class="comment"># &lt;-- false 로 해제됨을 확인 가능</span></span><br><span class="line">Total Shares           5</span><br><span class="line">Threshold              3</span><br><span class="line">Version                1.3.0</span><br><span class="line">Cluster Name           vault-cluster-6075fd5f</span><br><span class="line">Cluster ID             c08caafe-09e6-c546-3216-b30a5d289ece</span><br><span class="line">HA Enabled             <span class="literal">true</span></span><br><span class="line">HA Cluster             n/a</span><br><span class="line">HA Mode                standby</span><br><span class="line">Active Node Address    &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h2 id="authentication-인증-1"><a href="#authentication-인증-1" class="headerlink" title="authentication (인증)"></a>authentication (인증)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ vault login s.eRWvoMPfKdxk2ja7kqIlSuR6</span><br><span class="line">Success! You are now authenticated. The token information displayed below</span><br><span class="line">is already stored <span class="keyword">in</span> the token helper. You <span class="keyword">do</span> NOT need to run <span class="string">"vault login"</span></span><br><span class="line">again. Future Vault requests will automatically use this token.</span><br><span class="line">  </span><br><span class="line">Key                  Value</span><br><span class="line">---                  -----</span><br><span class="line">token                s.eRWvoMPfKdxk2ja7kqIlSuR6</span><br><span class="line">token_accessor       OcjXZLaLlkAIO9cyZj8eRrMZ</span><br><span class="line">token_duration       ∞</span><br><span class="line">token_renewable      <span class="literal">false</span></span><br><span class="line">token_policies       [<span class="string">"root"</span>]</span><br><span class="line">identity_policies    []</span><br><span class="line">policies             [<span class="string">"root"</span>]</span><br></pre></td></tr></table></figure>

<h1 id="HTTP-API"><a href="#HTTP-API" class="headerlink" title="HTTP API"></a>HTTP API</h1><p>http api 를 통해서도 여러가지 작업을 할 수 있습니다.<br>이전까지의 작업이 모두 cli 환경이었다면 마찬가지로 http api 도 동일하게 가능합니다.<br><a href="https://www.vaultproject.io/intro/getting-started/apis.html">https://www.vaultproject.io/intro/getting-started/apis.html</a></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/consul/" rel="tag"># consul</a>
              <a href="/tags/vault/" rel="tag"># vault</a>
              <a href="/tags/hashicorp/" rel="tag"># hashicorp</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/gitbash-alias/" rel="prev" title="gitbash alias">
      <i class="fa fa-chevron-left"></i> gitbash alias
    </a></div>
      <div class="post-nav-item">
    <a href="/docker-container-infinite-loop-method/" rel="next" title="docker container 죽지 않는 방법 (infinite loop command)">
      docker container 죽지 않는 방법 (infinite loop command) <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

          <!-- blog sidbar google ads start-->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog 게시물 하단 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3619868657611479"
     data-ad-slot="4733801133"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
<!-- blog sidbar google ads end-->
        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#vault-란"><span class="nav-number">1.</span> <span class="nav-text">vault 란?</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#server-실행"><span class="nav-number">2.</span> <span class="nav-text">server 실행</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#dev"><span class="nav-number">2.1.</span> <span class="nav-text">-dev</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#환경변수-등록"><span class="nav-number">2.2.</span> <span class="nav-text">환경변수 등록</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#vault-와-secret"><span class="nav-number">3.</span> <span class="nav-text">vault 와 secret</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#write-a-secret"><span class="nav-number">4.</span> <span class="nav-text">write a secret</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#getting-a-secret"><span class="nav-number">5.</span> <span class="nav-text">getting a secret</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#값-추출"><span class="nav-number">5.1.</span> <span class="nav-text">값 추출</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JSON-output"><span class="nav-number">5.2.</span> <span class="nav-text">JSON output</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#jq-활용"><span class="nav-number">5.3.</span> <span class="nav-text">jq 활용</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#deleting-a-secret"><span class="nav-number">6.</span> <span class="nav-text">deleting a secret</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#secrets-engines"><span class="nav-number">7.</span> <span class="nav-text">secrets engines</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#secrets-engine-활성화"><span class="nav-number">7.1.</span> <span class="nav-text">secrets engine 활성화</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#secrets-engine-비활성화"><span class="nav-number">7.2.</span> <span class="nav-text">secrets engine 비활성화</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#다른-환경과-연동"><span class="nav-number">7.3.</span> <span class="nav-text">다른 환경과 연동</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#dynamic-secrets-동적-비밀정보"><span class="nav-number">8.</span> <span class="nav-text">dynamic secrets (동적 비밀정보)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#AWS-secret-테스트"><span class="nav-number">8.1.</span> <span class="nav-text">AWS secret 테스트</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#AWS-secrets-engine-활성화"><span class="nav-number">8.1.1.</span> <span class="nav-text">AWS secrets engine 활성화</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#config-작성"><span class="nav-number">8.1.2.</span> <span class="nav-text">config 작성</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#role-작성"><span class="nav-number">8.1.3.</span> <span class="nav-text">role 작성</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#secret-생성"><span class="nav-number">8.1.4.</span> <span class="nav-text">secret 생성</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#secret-갱신-amp-획득"><span class="nav-number">8.1.5.</span> <span class="nav-text">secret 갱신 &amp; 획득</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#secret-제거"><span class="nav-number">8.1.6.</span> <span class="nav-text">secret 제거</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MYSQL-dynamic-sql-user-creation-테스트"><span class="nav-number">8.2.</span> <span class="nav-text">MYSQL dynamic sql user creation 테스트</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#database-secrets-engine-활성화"><span class="nav-number">8.2.1.</span> <span class="nav-text">database secrets engine 활성화</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#config-작성-1"><span class="nav-number">8.2.2.</span> <span class="nav-text">config 작성</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#role-작성-1"><span class="nav-number">8.2.3.</span> <span class="nav-text">role 작성</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#secret-생성-1"><span class="nav-number">8.2.4.</span> <span class="nav-text">secret 생성</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#authentication-인증"><span class="nav-number">9.</span> <span class="nav-text">authentication (인증)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#token-생성"><span class="nav-number">9.1.</span> <span class="nav-text">token 생성</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#token-삭제"><span class="nav-number">9.2.</span> <span class="nav-text">token 삭제</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#token-을-통한-인증"><span class="nav-number">9.3.</span> <span class="nav-text">token 을 통한 인증</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#다양한-인증-방식"><span class="nav-number">10.</span> <span class="nav-text">다양한 인증 방식</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#github-인증-테스트"><span class="nav-number">10.1.</span> <span class="nav-text">github 인증 테스트</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#github-설정"><span class="nav-number">10.1.1.</span> <span class="nav-text">github 설정</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#github-인증-활성화"><span class="nav-number">10.1.2.</span> <span class="nav-text">github 인증 활성화</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#github-인증-설정"><span class="nav-number">10.1.3.</span> <span class="nav-text">github 인증 설정</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#등록된-인증-확인"><span class="nav-number">10.1.4.</span> <span class="nav-text">등록된 인증 확인</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#인증"><span class="nav-number">10.1.5.</span> <span class="nav-text">인증</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#polices-정책"><span class="nav-number">11.</span> <span class="nav-text">polices (정책)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#policy-format"><span class="nav-number">11.1.</span> <span class="nav-text">policy format</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#fmt"><span class="nav-number">11.1.1.</span> <span class="nav-text">fmt</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#writing-the-police"><span class="nav-number">11.2.</span> <span class="nav-text">writing the police</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#list-of-policies"><span class="nav-number">11.3.</span> <span class="nav-text">list of policies</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#view-contents-of-policy"><span class="nav-number">11.4.</span> <span class="nav-text">view contents of policy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#policy-test"><span class="nav-number">11.5.</span> <span class="nav-text">policy test</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#정책이-반영된-toke-발행"><span class="nav-number">11.5.1.</span> <span class="nav-text">정책이 반영된 toke 발행</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#해당-token-으로-인증"><span class="nav-number">11.5.2.</span> <span class="nav-text">해당 token 으로 인증</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kv-쓰기-테스트"><span class="nav-number">11.5.3.</span> <span class="nav-text">kv 쓰기 테스트</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#deploy-vault"><span class="nav-number">12.</span> <span class="nav-text">deploy vault</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#server-설정"><span class="nav-number">12.1.</span> <span class="nav-text">server 설정</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#server-start-with-config-hcl"><span class="nav-number">12.2.</span> <span class="nav-text">server start with config.hcl</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#vault-초기화"><span class="nav-number">12.3.</span> <span class="nav-text">vault 초기화</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#sear-unseal-봉인-해제"><span class="nav-number">12.4.</span> <span class="nav-text">sear &#x2F; unseal (봉인 &#x2F; 해제)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#authentication-인증-1"><span class="nav-number">12.5.</span> <span class="nav-text">authentication (인증)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#HTTP-API"><span class="nav-number">13.</span> <span class="nav-text">HTTP API</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="이재욱이"
      src="https://avatars2.githubusercontent.com/u/11376406?s=460&v=4">
  <p class="site-author-name" itemprop="name">이재욱이</p>
  <div class="site-description" itemprop="description">소스코드 파밍중...</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">41</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">76</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/lejewk" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;lejewk" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:lighten518@gmail.com" title="E-Mail → mailto:lighten518@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">이재욱이</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.7.2
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
